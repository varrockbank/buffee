<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="reset.css">
<script src="vbuf.js"></script>
<script src="extensions/tui-legacy.js"></script>
<style>
  /*** Classes for Buffee ***/
  .wb {
      background-color: #282C34;
      color: #B2B2B2;
      position: relative;
      outline: none;
      font-family: 'Monaco', 'Menlo', 'Consolas', 'Courier New', monospace;
      border: 1px solid black;
  }
  .no-select {
      user-select: none;       /* Standard */
      -webkit-user-select: none; /* Safari */
      -moz-user-select: none;    /* Firefox */
      -ms-user-select: none;     /* IE/Edge (old) */
  }
  /* Bridge must be selectable but invisible & offscreen */
  .wb-clipboard-bridge {
      position: fixed;      /* out of normal flow so it won't jump layout */
      left: 0;
      top: 1px;
      width: 0;
      height: 1px;
      opacity: 0;
      pointer-events: none; /* avoid clicks */
  }

  .wb .wb-lines>pre::before {
      content: "\200B";
  }
  .wb .wb-lines pre {
      margin: 0;
      overflow: hidden;
  }
  .wb .wb-selection {
      left: 0ch;
      top: 0ch;
      background-color: #EDAD10;
      position: absolute;
      mix-blend-mode: difference;        /* inverts underlying pixels */
  }
  .wb .wb-cursor {
      background-color: #FF6B6B;
      mix-blend-mode: exclusion;
  }
  .wb .wb-status {
      padding: 6px;
  }
  .wb .wb-status span {
      padding-right: 4px;
  }
  .wb .wb-lines pre .highlight-function {
      color: orange;
  }
  .wb .wb-lines pre .highlight-function-name {
      color: cadetblue ;
  }
  .wb .wb-lines pre .highlight-string {
      color: green;
  }

  #hackernews.wb {
      background-color: #F6F6EF;
      color: black;
  }
  #hackernews.wb .wb-selection {
      background-color: #DCDCDA;
  }

  #playground.wb {
    background-color: #201430;
    color: #E1D6F8;
  }
  #playground.wb .wb-selection {
    background-color: #F9AD40;
  }

  /* TUI Mode demo styling */
  #tui-demo.wb {
    background-color: #1a1a2e;
    color: #eaeaea;
  }
  #tui-demo.wb .wb-selection {
    background-color: #9d4edd;
  }
</style>
</head>

<body>
  <nav id="nav"></nav>
  <script>
    fetch('navigation.html')
      .then(r => r.text())
      .then(html => document.getElementById('nav').innerHTML = html);
  </script>
  <p><strong>buffee, the text slayer</strong> (<span id="vbuf-version"></span>) ‚Äî the anti-hero text editor for the web ‚Äî compact, fast, unleashed</p>

  <!-- Features Section -->
  <div style="padding: 12px 0;">
    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 32px;">
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">0.01MB</h3>
        <p style="margin: 0; font-size: 14px;">(gzip+min) distributable</p>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">0</h3>
        <p style="margin: 0; font-size: 14px;">Dependencies</p>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">0ms</h3>
        <p style="margin: 0; font-size: 14px;">Build time</p>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">0ms</h3>
        <p style="margin: 0; font-size: 14px;">VDOM overhead</p>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">~70m</h3>
        <p style="margin: 0; font-size: 14px;">LOC capacity</p>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 32px; margin: 0 0 8px 0; font-weight: 700;">1B+</h3>
        <p style="margin: 0; font-size: 14px;">in <a href="samples/ultra-high-capacity.html">pro max mode</a></p>
      </div>
    </div>
  </div>

    <!-- Main Playground -->
    <section>
      <blockquote cite="" class="üí™ üçú ü•∑ üåï ü™ú wb no-select" tabindex="0" id="playground">
        <!-- Hidden clipboard bridge lives inside the editor so copy bubbles through it -->
        <textarea class="wb-clipboard-bridge" aria-hidden="true"></textarea>
          <div class="üí™">
              <div class="wb-gutter"></div>
              <div class="wb-lines üå≥ ü•∑"></div>
          </div>
          <div class="üí™ wb-status ü¶†">
              <div class="wb-status-left üí™">
                  <span class="wb-linecount"></span>
              </div>
              <div class="wb-status-right üí™">
                  <span class="wb-coordinate"></span>
                  <span>|</span>
                  <span class="wb-indentation"></span>
              </div>
          </div>
      </blockquote>
    </section>

    <!-- About -->
    <section>
      <h3>Text slayer, editor, UI</h3>
      <p>Essentially this a rendering engine for fixed-width cells in grid-layout.
        The grid being viewport into an arbitrarily large buffer of text lines.
      </p>
      <p>The core implementation tightly couples rendering and text editor capabilities.
        The original prototype served to view large distributed server logs. 
        It turns out that making performance headway in this area translates to being a performant text editor.
        The key optimization is sidestepping DOM bottlenecks and avoiding JavaScript fatigue. 
      </p>
      <p>
        TUI capabilities ship as extension.
        A separate dream of the author is to liberate OrgMode from the confines of Emacs.
        This is the realm of text-based interfaces, err... operating systems.
        The advent of AI coding has also resurged interest in TUIs, namely 
        terminal-based agentic prompts. Buffee completes the circle:
        as <a href="https://github.com/dankamongmen/notcurses">notcurses</a> brings browser bling to the terminal, buffee brings 20th century drab 
        to the modern web.  
      </p>
      </p>
      <p>
        We'd like to thank the wizards of V8. Compactness is possible because V8 arrays proved instaneously fast. Compare with complex 
        structures, plural, needed by native editors, e.g. <a href="https://code.visualstudio.com/blogs/2018/03/23/text-buffer-reimplementation">piecetable</a>. 
        Content/syntax-aware considerations aside, buffee rivals or outperforms titans of the text editor industry. 
      </p>
    </section>

    <!-- TUI Mode Demo -->
    <section>
      <h3>TUI Mode</h3>
      <p>Terminal UI mode placing interactive elements in the buffer. <kbd>Tab</kbd> to next element. <kbd>Enter</kbd> to activate.</p>

      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
        <button id="tui-toggle-btn">Enable TUI Mode</button>
        <button id="tui-highlight-toggle-btn" class="hidden">Highlight All</button>
      </div>
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
        <label>Row:</label>
        <input type="number" id="tui-row" value="0" style="width: 60px;">
        <label>Col:</label>
        <input type="number" id="tui-col" value="0" style="width: 60px;">
        <label>Content:</label>
        <input type="text" id="tui-content" value="Foobar" style="width: 120px;">
        <button id="tui-add-btn">Add Element</button>
      </div>
      <blockquote cite="" class="üí™ üçú ü•∑ üåï ü™ú wb no-select" tabindex="0" id="tui-demo">
        <textarea class="wb-clipboard-bridge" aria-hidden="true"></textarea>
        <div class="üí™">
          <div class="wb-gutter"></div>
          <div class="wb-lines üå≥ ü•∑"></div>
        </div>
        <div class="üí™ wb-status ü¶†">
          <div class="wb-status-left üí™">
            <span class="wb-linecount"></span>
          </div>
          <div class="wb-status-right üí™">
            <span class="wb-coordinate"></span>
            <span>|</span>
            <span class="wb-indentation"></span>
          </div>
        </div>
      </blockquote>
    </section>

    <!-- iOS Support Demo -->
    <section>
      <h3>iOS Support</h3>
      <p>This editor demonstrates mobile support with the iOS plugin, enabling touch interactions and on-screen keyboard input.</p>
      <blockquote cite="" class="üí™ üçú ü•∑ üåï ü™ú wb no-select" tabindex="0" id="notes">
        <!-- Hidden clipboard bridge lives inside the editor so copy bubbles through it -->
        <textarea class="wb-clipboard-bridge" aria-hidden="true"></textarea>
        <div class="üí™">
          <div class="wb-gutter"></div>
          <div class="wb-lines üå≥ ü•∑"></div>
        </div>
        <div class="üí™ wb-status ü¶†">
          <div class="wb-status-left üí™">
            <span class="wb-linecount"></span>
          </div>
          <div class="wb-status-right üí™">
            <span class="wb-coordinate"></span>
            <span>|</span>
            <span class="wb-indentation"></span>
          </div>
        </div>
      </blockquote>
    </section>

    <!-- Dynamic Data Demo -->
    <section>
      <h3>HackerNews Front Page</h3>
      <p>Example of loading data from APIs.</p>
    <blockquote cite="" class="üí™ üçú ü•∑ üåï ü™ú wb no-select" tabindex="0" id="hackernews">
      <!-- Hidden clipboard bridge lives inside the editor so copy bubbles through it -->
      <textarea class="wb-clipboard-bridge" aria-hidden="true"></textarea>
      <div class="üí™">
        <div class="wb-gutter"></div>
        <div class="wb-lines üå≥ ü•∑"></div>
      </div>
      <div class="üí™ wb-status ü¶†">
        <div class="wb-status-left üí™">
          <span class="wb-linecount"></span>
        </div>
        <div class="wb-status-right üí™">
          <span class="wb-coordinate"></span>
          <span>|</span>
          <span class="wb-indentation"></span>
        </div>
      </div>
    </blockquote>
    </section>
  </div> <!-- End container -->

  <script type="module">
    import { Parser, Language, Query } from "https://cdn.jsdelivr.net/npm/web-tree-sitter@0.25.10/tree-sitter.js";

    await Parser.init(); // loads tree-sitter.wasm from the same CDN path
    const treesitterParser = new Parser();
    const javascriptParser = await Language.load(
      "https://cdn.jsdelivr.net/npm/tree-sitter-wasms@0.1.12/out/tree-sitter-javascript.wasm"
    );
    treesitterParser.setLanguage(javascriptParser);
    const highlightQuery = `
      (function_declaration name: (identifier) @function)
      (string) @string
    `;
    const query = new Query(javascriptParser, highlightQuery);
    
    window.treesitterInstance = {
       query,
       parser: treesitterParser 
    };

</script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const mainElement = document.getElementById("playground");
    const primary = new Buffee(mainElement, {
      colorPrimary: "#87FF5F",
      colorSecondary: "#38274D"
    });
    mainElement.focus();
    window.primary = primary;

    // Set version from vbuf instance
    document.getElementById('vbuf-version').textContent = 'v' + primary.version;

    const notesElement = document.getElementById('notes');
    const notes = new Buffee(notesElement);

    const hackerNewsElement = document.getElementById('hackernews');
    const hackernews = new Buffee(hackerNewsElement, {
      colorPrimary: "black",
      colorSecondary: "#FF6602",
      showStatusLine: false,
    });

    fetch("docs/instructions.txt")
      .then(response => response.text())
      .then(source => primary.Model.text = source)
      .catch(err => console.error("Error reading instructions.txt:", err));

    fetch("docs/devlog.txt")
      .then(response => response.text())
      .then(source => notes.Model.text = source)
      .catch(err => console.error("Error reading devlog.txt:", err));

    // Fetch Hacker News as plaintext
    async function fetchHackerNewsText() {
      const response = await fetch('https://hacker-news.firebaseio.com/v0/topstories.json');
      const storyIds = await response.json();

      // Get top 30 stories
      const stories = await Promise.all(
        storyIds.slice(0, 30).map(async (id) => {
          const storyRes = await fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`);
          return storyRes.json();
        })
      );

      // Format as plaintext
      const plaintext = stories
        .map((story, i) => {
          const title = story.title || 'No title';
          const url = story.url || `https://news.ycombinator.com/item?id=${story.id}`;
          const points = story.score || 0;
          const comments = story.descendants || 0;
          return `${i + 1}. ${title}\n   ${url}\n   ${points} points | ${comments} comments\n`;
        })
        .join('\n');

      return plaintext;
    }

    fetchHackerNewsText()
      .then(text => hackernews.Model.text = text)
      .catch(err => console.error("Error fetching Hacker News:", err));

    // TUI Mode Demo
    const tuiDemoElement = document.getElementById('tui-demo');
    const tuiDemo = new Buffee(tuiDemoElement, {
      colorPrimary: "#eaeaea",
      colorSecondary: "#16213e",
      initialViewportSize: 15,
    });
    BuffeeTUI(tuiDemo);  // Initialize TUI extension

const fileTemplate = `
                ‚ïë
‚îÄ‚î§‚ñë‚ñë‚ñë‚ñëFiles‚ñë‚ñë‚ñë‚îú‚îÄ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£       
                ‚ïë
                ‚ïë              
                ‚ïë                   
                ‚ïë              
                ‚ïë        
                ‚ïë
                ‚ïë                    
                ‚ïë
`;
    // File contents
    const files = {
      'main.js': [
        'function main() {',
        '  console.log("Hello");',
        '  init();',
        '}',
        '',
        'main();'
      ],
      'styles.css': [
        'body {',
        '  margin: 0;',
        '  font-family: sans;',
        '}',
        '.btn { color: blue; }'
      ],
      'config.json': [
        '{',
        '  "name": "myapp",',
        '  "version": "1.0",',
        '  "port": 3000',
        '}'
      ],
      'README.md': [
        '# My Project',
        '',
        'A demo application.',
        '',
        '## Install',
        'npm install'
      ],
      'index.html': [
        '<!DOCTYPE html>',
        '<html>',
        '<head>',
        '  <title>App</title>',
        '</head>',
        '<body></body>',
        '</html>'
      ],
      'data.csv': [
        'name,age,city',
        'Alice,30,NYC',
        'Bob,25,LA',
        'Carol,35,Chicago'
      ],
      '.env': [
        'API_KEY=sk-xxx',
        'DEBUG=true',
        'PORT=8080'
      ],
      'notes.txt': [
        'TODO:',
        '- Fix bug #42',
        '- Add tests',
        '- Update docs'
      ]
    };

    // Track element IDs for each file
    const fileElementIds = {};

    // Function to load file content
    function loadFile(name) {
      // Update buttons: remove and re-add with updated content
      const fileNames = Object.keys(files);
      fileNames.forEach((fname, i) => {
        if (fileElementIds[fname]) {
          tuiDemo.TUI.removeElement(fileElementIds[fname]);
        }
        const label = fname === name ? '> ' + fname : '  ' + fname;
        fileElementIds[fname] = tuiDemo.TUI.addButton({
          row: i + 3,
          col: 2,
          label,
          onActivate: () => loadFile(fname)
        });
      });

      const lines = tuiDemo.Model.lines;
      const content = files[name] || [];
      for (let i = 0; i < lines.length; i++) {
        // Skip rows 1-2 (header/separator rows)
        if (i === 1 || i === 2) continue;

        // Find the divider position dynamically
        const dividerPos = lines[i].search(/[‚ïë‚ï†‚ï£]/);
        if (dividerPos === -1) continue;

        let right;
        if (i === 0) {
          // Show filename in header - preserve the 16 spaces before ‚ïë
          lines[i] = '                ‚ïë' + ' ' + name;
          continue;
        }
        const left = lines[i].slice(0, dividerPos + 1); // Keep left side + divider
        if (i >= 3) {
          // Content starts at row 3
          right = ' ' + (content[i - 3] || '');
        }
        lines[i] = left + right;
      }
      // Trigger re-render
      tuiDemo.TUI.enabled = true;
    }

    // Initialize with template
    tuiDemo.Model.text = fileTemplate.trim();

    // Show initial file (also creates the file list elements)
    loadFile('main.js');

    // Add a prompt at the bottom
    tuiDemo.TUI.addPrompt({
      row: 12,
      col: 18,
      width: 40,
      title: 'Command',
      onActivate: (el) => alert('Command: ' + el.input)
    });

    // Enable TUI mode by default
    tuiDemo.TUI.enabled = true;
    document.getElementById('tui-toggle-btn').textContent = 'Disable TUI Mode';

    const tuiHighlightBtn = document.getElementById('tui-highlight-toggle-btn');
    tuiHighlightBtn.classList.remove('hidden');
    tuiHighlightBtn.textContent = 'Unhighlight All';
    let tuiHighlighted = true;

    document.getElementById('tui-toggle-btn').addEventListener('click', () => {
      tuiDemo.TUI.enabled = !tuiDemo.TUI.enabled;
      document.getElementById('tui-toggle-btn').textContent = tuiDemo.TUI.enabled ? 'Disable TUI Mode' : 'Enable TUI Mode';
      tuiHighlightBtn.classList.toggle('hidden', !tuiDemo.TUI.enabled);
    });

    tuiHighlightBtn.addEventListener('click', () => {
      tuiHighlighted = !tuiHighlighted;
      tuiDemo.TUI.setHighlight(tuiHighlighted);
      tuiHighlightBtn.textContent = tuiHighlighted ? 'Unhighlight All' : 'Highlight All';
    });

    document.getElementById('tui-add-btn').addEventListener('click', () => {
      const row = parseInt(document.getElementById('tui-row').value) || 0;
      const col = parseInt(document.getElementById('tui-col').value) || 0;
      const label = document.getElementById('tui-content').value || 'Button';
      tuiDemo.TUI.addButton({ row, col, label });
    });

    // Bind Tab to nextElement, other keys to handleKeyDown in TUI mode
    tuiDemoElement.addEventListener('keydown', (e) => {
      if (!tuiDemo.TUI.enabled) return;
      if (e.key === 'Tab') {
        e.preventDefault();
        tuiDemo.TUI.nextElement();
      } else {
        e.preventDefault();
        tuiDemo.TUI.handleKeyDown(e.key);
      }
    });

    // Expose for debugging
    window.tuiDemo = tuiDemo;

    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
      const notesEditingArea = notesElement.querySelector('.wb-lines');
   
      // Use contenteditable so tapping opens the keyboard
      editor.setAttribute('contenteditable', 'true');
      editor.setAttribute('role', 'textbox');
      editor.setAttribute('aria-multiline', 'true');
      editor.setAttribute('spellcheck', 'false');
      editor.setAttribute('autocapitalize', 'off');
      editor.setAttribute('autocorrect', 'off');
      editor.setAttribute('inputmode', 'text');

      // ---------- iOS adapter: hidden textarea "input sink" ----------
      const sink = document.createElement('textarea');
      sink.setAttribute('autocapitalize', 'off');
      sink.setAttribute('autocorrect', 'off');
      sink.setAttribute('spellcheck', 'false');
      Object.assign(sink.style, {
        position: 'fixed',
        opacity: 0,
        left: '0',
        top: '0',
        height: '1px',
        width: '1px',
      });
      // Fake out a deletion event so iOS fires deleteContentBackward input time
      // Otherwise the keyboard handler with a synthetic Backspace event is never claled.
      const L = '\u200B';           // left sentinel (zero-width space)
      const R = '\u200B';           // right sentinel (optional, helps if you add ForwardDelete later)
      sink.value = L + R ;
      document.body.appendChild(sink);
      function resetSink() {
        sink.value = L + R;                 // always 2 chars
        sink.selectionStart = sink.selectionEnd = 1; // caret between L and R
      }

      // Measure 1ch using the div's font (reliable across browsers)
      function measureChWidth() {
        // Fast path using CSS 1ch
        const probe = document.createElement('span');
        probe.textContent = '0';
        // Match the target div‚Äôs font & letter spacing
        const cs = getComputedStyle(notesEditingArea);
        probe.style.font = cs.font;
        probe.style.letterSpacing = cs.letterSpacing;
        probe.style.visibility = 'hidden';
        probe.style.position = 'absolute';
        probe.style.whiteSpace = 'pre';
        document.body.appendChild(probe);
        const w = probe.getBoundingClientRect().width;
        document.body.removeChild(probe);
        return w;
      }
      let ch = measureChWidth();
      // Recompute on font changes / resize (optional but nice)
      new ResizeObserver(() => { ch = measureChWidth(); }).observe(notesEditingArea);

      function getPoint(evt) {
        const rect = notesEditingArea.getBoundingClientRect();
        const touch = evt.changedTouches?.[0] ?? evt.touches?.[0];
        const clientX = touch ? touch.clientX : evt.clientX;
        const clientY = touch ? touch.clientY : evt.clientY;
        // position inside content box, including scroll offset
        // (rect gives viewport coords; add scroll to get content coords)
        const x = (clientX - rect.left) + notesEditingArea.scrollLeft;
        const y = (clientY - rect.top)  + notesEditingArea.scrollTop;
        // subtract padding so (0,0) = top-left of text content, not the padding
        const cs = getComputedStyle(notesEditingArea);
        const padL = parseFloat(cs.paddingLeft)  || 0;
        const padT = parseFloat(cs.paddingTop)   || 0;
        return { x: x - padL, y: y - padT };
      }

      function setCursor(evt) {
        const { x, y } = getPoint(evt);
        const row = Math.max(0, Math.floor(y / 24));
        const col = Math.max(0, Math.floor(x / ch));
        notes.Selection.iosSetCursorAndRender({ row, col });
      }

      // Map beforeinput ‚Üí synthetic keydown(s)
      sink.addEventListener('beforeinput', (e) => {
        // We consume the DOM change; we‚Äôll notify the editor via keydown.
        e.preventDefault();

        if(e.inputType === 'insertText') {
          for (const ch of e.data || '') synthKeydown(ch);
        } else if (e.inputType === 'deleteContentBackward') {
          synthKeydown('Backspace');
        } else if (e.inputType === 'insertLineBreak') {
          synthKeydown('Enter');
        }
        resetSink(); // <- ALWAYS restore L‚Ä¢R with caret in the middle
      });
      // IME/dictation: commit composed text as keydowns
      sink.addEventListener('compositionend', (e) => {
        if (e.data) {
          for (const ch of e.data) synthKeydown(ch);
        }
      });
      // Helper: dispatch a synthetic keydown into your editor
      function synthKeydown(key) {
        // Use only what your handler needs; e.key is the important bit.
        const ev = new KeyboardEvent('keydown', {
          key,
          bubbles: true,
          cancelable: true,
          // Best-effort code; fine if it's not perfect for non-letters.
          code: key.length === 1 ? ('Key' + key.toUpperCase()) : key
        });
        // Some code checks isTrusted; this won‚Äôt be trusted, so avoid that check.
        editor.dispatchEvent(ev);
      }

      // Focus on tap (otherwise iOS may not show keyboard)
      // Focus the sink on tap so iOS shows the keyboard.
      editor.addEventListener('pointerdown', e => {
        sink.focus({preventScroll: true});
        setCursor(e);
      });
    }
  });
</script>
</body>
</html>
