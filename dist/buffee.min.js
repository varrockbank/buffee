function Buffee(e,{rows:t,cols:o,spaces:s=4,logger:l}={}){this.version="12.3.3-alpha.1";const n=this,r=e=>a.spaces?e.replace(/\t/g," ".repeat(a.spaces)):e,i=e=>/\s/.test(e),c=e=>/[\p{L}\p{Nd}_]/u.test(e),a={spaces:s,interactive:1},h=t=>parseFloat(getComputedStyle(e).getPropertyValue(t)),d=h("--buffee-cell"),f=h("--buffee-padding"),w=h("--buffee-gutter-digits-initial");let u=-1;const g=()=>u+h("--buffee-gutter-digits-padding"),p=(e,t)=>e.querySelector(t),y=p(e,".buffee-elements"),m=p(y,".buffee-lines"),v=p(y,".buffee-cursor"),C=p(y,".buffee-layer-text"),k=p(e,".buffee-clipboard-bridge"),L=p(y,".buffee-gutter");if(o&&!L&&(y.style.width=`calc(${o}ch + ${2*f}px)`),t){const e=t*d+"px";C.style.height=e,L&&(L.style.height=e)}const S=[],[x,b,z]=[0,0,0].map(()=>document.createDocumentFragment()),K={row:0,col:0};let _={row:0,col:0},D=_,M=_.col;const E=this.Selection={get ordered(){return this.isForwardSelection?[D,_]:[_,D]},moveRow(e){e>0?_.row<I.lastIndex&&(_.col=Math.min(M,I.lines[++_.row].length),_.row>F.end&&(F.start=_.row-F.size+1)):_.row>0&&(_.col=Math.min(M,I.lines[--_.row].length),_.row<F.start&&(F.start=_.row)),H()},moveCol(e){1===e?_.col<I.lines[_.row].length?M=++_.col:_.row<I.lastIndex&&(M=_.col=0,++_.row>F.end&&(F.start=_.row-F.size+1)):_.col>0?M=--_.col:_.row>0&&(M=_.col=I.lines[--_.row].length,_.row<F.start&&(F.start=_.row)),H()},get isSelection(){return _!==D},get isForwardSelection(){return D.row===_.row&&D.col<_.col||D.row<_.row},setCursor({row:e,col:t}){_.row=e,_.col=t,this.makeCursor()},get lines(){const[e,t]=this.ordered;if(e.row===t.row){const o=I.lines[e.row],s=e.row===I.lastIndex,l=o.slice(e.col,t.col);return t.col>=o.length&&!s?[l,""]:[l]}{const o=I.lines[e.row].slice(e.col),s=I.lines[t.row].slice(0,t.col);return[o,...I.lines.slice(e.row+1,t.row),s]}},makeCursor(){D.row=_.row,D.col=_.col,_=D},makeSelection(){_=K,_.row=D.row,_.col=D.col},moveCursorStartOfLine(){var e;M=_.col=(e=I.lines[_.row].search(/[^ ]/))>0&&e<D.col?e:0,H()},moveCursorEndOfLine(){M=_.col=I.lines[_.row].length,H()},insert(e,t=!1){if(e=r(e),this.isSelection){const[t]=this.ordered,o=this.lines.join("\n");n._._delete(t.row,t.col,o);const s=n._._insert(t.row,t.col,e);s?.length>1?(_.row=t.row+s.length-1,_.col=s[s.length-1].length):(_.row=t.row,_.col=t.col+e.length),this.makeCursor()}else{const t=n._._insert(D.row,D.col,e);t?.length>1?(_.row+=t.length-1,M=_.col=t[t.length-1].length):M=_.col+=e.length}t||H()},delete(){if(this.isSelection)return this.insert("");if(D.col>0){const e=I.lines[D.row][D.col-1];n._._delete(D.row,D.col-1,e),_.col--}else if(D.row>0){const e=I.lines[D.row-1].length;n._._delete(D.row-1,e,"\n"),_.col=e,_.row--,_.row<F.start&&(F.start=_.row)}H()},newLine(){this.isSelection&&E.insert("",!0),n._._insert(D.row,D.col,"\n"),_.col=0,_.row++,_.row>F.end&&(F.start=_.row-F.size+1),H()},moveBackWord(){if(0===_.col)_.row>0&&(_.col=I.lines[--_.row].length,_.row<F.start&&(F.start=_.row));else{const e=I.lines[_.row];let t=_.col;if(i(e[t])){for(;t>0&&i(e[t]);)t--;for(;t>0&&c(e[t]);)t--}else if(c(e[t]))for(;t>0&&c(e[t]);)t--;else{const o=e[t--];for(;t>0&&e[t]===o;)t--}_.col=t}H()},moveWord(){const e=I.lines[_.row],t=e.length;if(_.col===t)_.row<I.lastIndex&&(_.col=0,++_.row>F.end&&(F.start=_.row-F.size+1));else{let o=_.col;if(i(e[o])){for(;o<t&&i(e[o]);)o++;for(;o<t&&c(e[o]);)o++}else if(c(e[o]))for(;o<t&&c(e[o]);)o++;else{const s=e[o++];for(;o<t&&e[o]===s;)o++}_.col=o}H()},indent(){if(!this.isSelection)return;const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)I.lines[o]=" ".repeat(a.spaces)+I.lines[o];e.col+=a.spaces,t.col+=a.spaces,H()},unindent(){const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)if(o===e.row||o===t.row){const s=o===e.row?e:t;let l=0,n=0;const r=I.lines[s.row];let i=s.col;for(;i<r.length&&" "===r.charAt(i);)i++;for(n=i-s.col,i=0;i<s.col&&" "===r.charAt(i);)i++;l=i;const c=Math.min(a.spaces,l+n);I.lines[s.row]=I.lines[s.row].slice(c),n<c&&(s.col-=c-n)}else{const e=I.lines[o];let t=0;for(;t<a.spaces&&" "===e[t];)t++;I.lines[o]=e.slice(t)}H()}},$=[],I=this.Model={lines:[""],byteCount:"",originalLineCount:0,get lastIndex(){return this.lines.length-1},set text(e){e=r(e),this.lines=e.split("\n"),this.byteCount=(new TextEncoder).encode(e).length,this.originalLineCount=this.lines.length,H()},splice(e,t,o=0){this.lines.splice(e,o,...t),H()},delete(e){this.lines.splice(e,1)}};const F=this.Viewport={start:0,autoFit:t?0:1,size:t||0,delta:t||1,get displayLines(){return this.size+this.autoFit},get end(){return Math.min(this.start+this.size-1,I.lastIndex)},scroll(e){this.start=$clamp(this.start+e,0,I.lastIndex),H()},set(e,t){this.start=$clamp(e-1,0,I.lastIndex),this.delta+=t-this.size,this.size=t,H()},get lines(){return I.lines.slice(this.start,this.end+1)}};let O=0;function A(e,t,o){const s=S[e].style;null!=t&&(s.left=t+"ch"),null!=o&&(s.width=o+"ch")}function H(){if(O++,L){const e=Math.max(w,(F.start+F.displayLines).toString().length);e!==u&&(u=e,L.style.width=g()+"ch",o&&(y.style.width=`calc(${g()+o}ch + ${4*f}px)`))}const e=F.delta;if(e){if(e>0){const t=S.length;for(let o=0;o<e;o++){x.appendChild(document.createElement("pre")),z.appendChild(document.createElement("div"));const e=S[t+o]=b.appendChild(document.createElement("div"));e.className="buffee-selection",e.style.top=(t+o)*d+"px"}C.appendChild(x),m.appendChild(b),L&&L.appendChild(z)}else for(let t=0;t<-e;t++)L&&L.lastChild?.remove(),C.lastChild?.remove(),S.pop()?.remove();F.delta=0}for(let e=0;e<F.displayLines;e++)L&&(L.children[e].textContent=F.start+e+1),C.children[e].textContent=I.lines[F.start+e]??null,S[e].style.width=0;if(a.interactive<0)v.style.left="-1ch";else{const[e,t]=E.ordered,o=e.row-F.start,s=t.row-F.start;for(let o=e.row+1;o<=t.row-1;o++){const e=o-F.start;e>=0&&e<F.size&&A(e,0,I.lines[o].length+1)}if(o>=0&&o<F.size){const s=t.row===e.row?t.col-e.col:I.lines[e.row].length-e.col+1;A(o,e.col,s)}if(t.row!==e.row&&s>=0&&s<F.size){A(s,0,Math.min(t.col,I.lines[t.row].length))}const l=_.row-F.start;if(l>=0&&l<F.size){v.style.top=l*d+"px",v.style.left=_.col+"ch";const e=m.getBoundingClientRect(),t=v.getBoundingClientRect(),o=t.width||14;if(t.left<e.left){const s=e.left-t.left,l=Math.ceil(s/o);m.scrollLeft-=l*o}else if(t.right>e.right){const s=t.right-e.right,l=Math.ceil(s/o);m.scrollLeft+=l*o}m.scrollLeft=Math.round(m.scrollLeft/o)*o}}for(const t of $)t(m,F,e)}if(this.lineHeight=d,this.Mode=a,this._={get head(){return _},get tail(){return D},get frameCount(){return O},get contentOffset(){return{ch:L?g():0,px:L?3*f:f,top:f}},$e:y,$l:m,$textLayer:C,render:H,renderHooks:$,_insert:function(e,t,o){if(0===o.length)return null;if(1===o.length&&"\n"!==o)return I.lines[e]=I.lines[e].slice(0,t)+o+I.lines[e].slice(t),null;const s=o.split("\n");if(1===s.length)I.lines[e]=I.lines[e].slice(0,t)+o+I.lines[e].slice(t);else{const o=I.lines[e].slice(0,t),l=I.lines[e].slice(t);I.lines[e]=o+s[0];const n=s.slice(1,-1),r=s[s.length-1]+l;I.lines.splice(e+1,0,...n,r)}return s},_delete:function(e,t,o){if(0===o.length)return;const s=o.split("\n");if(1===s.length)I.lines[e]=I.lines[e].slice(0,t)+I.lines[e].slice(t+o.length);else{const o=I.lines[e].slice(0,t),l=e+s.length-1,n=s[s.length-1].length,r=I.lines[l].slice(n);I.lines[e]=o+r,I.lines.splice(e+1,s.length-1)}},appendLines(e,t=!1){I.lines.push(...e.map(r)),t||H()}},F.autoFit){const e=()=>{const e=Math.floor(y.clientHeight/d);e>0&&e!==F.size&&(F.delta+=e-F.size,F.size=e,H())};requestAnimationFrame(e),new ResizeObserver(e).observe(y)}else H();m.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");t&&E.insert(t)});const B=e=>{e.preventDefault(),e.clipboardData.setData("text/plain",E.lines.join("\n"))};k.addEventListener("copy",B),k.addEventListener("cut",e=>{B(e),E.delete(),m.focus({preventScroll:!0})});const R={ArrowDown:2,ArrowUp:-2,ArrowLeft:-1,ArrowRight:1};m.addEventListener("keydown",e=>{if((e.metaKey||e.ctrlKey)&&"v"===e.key.toLowerCase())return;if((e.metaKey||e.ctrlKey)&&("c"===e.key.toLowerCase()||"x"===e.key.toLowerCase()))return k.focus({preventScroll:!0}),void k.select();if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&!e.shiftKey)return e.preventDefault(),void(n.History&&n.History.undo());if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&e.shiftKey)return e.preventDefault(),void(n.History&&n.History.redo());const t=R[e.key]||0;if(t){const o=t>>31|1;if(e.preventDefault(),-1===a.interactive)return;if(e.metaKey)!e.shiftKey&&E.isSelection&&E.makeCursor(),e.shiftKey&&!E.isSelection&&E.makeSelection(),t%2&&E[o>0?"moveCursorEndOfLine":"moveCursorStartOfLine"]();else if(e.altKey)!e.shiftKey&&E.isSelection&&E.makeCursor(),e.shiftKey&&!E.isSelection&&E.makeSelection(),t%2&&E[o>0?"moveWord":"moveBackWord"]();else if(!e.shiftKey&&E.isSelection)if(t%2)E.setCursor(E.ordered[o>0|0]),H();else{const e=E.ordered[o>0|0],t=$clamp(e.row+o,0,I.lastIndex);t<F.start?F.start=t:t>F.end&&(F.start=t-F.size+1),M=Math.min(e.col,I.lines[t].length),E.setCursor({row:t,col:M}),H()}else e.shiftKey&&!E.isSelection&&E.makeSelection(),E[t%2?"moveCol":"moveRow"](o)}else 1!==a.interactive||("Backspace"===e.key?E.delete():"Enter"===e.key?E.newLine():"Escape"===e.key||("Tab"===e.key?(e.preventDefault(),e.shiftKey?E.unindent():E.isSelection?E.indent():E.insert(" ".repeat(a.spaces))):e.key.length>1?l.warn("Ignoring unknown key: ",e.code,e.key):(" "===e.key&&e.preventDefault(),E.insert(e.key))))})}function $clamp(e,t,o){return e<t?(logger.warn("Out of bounds"),t):e>o?(logger.warn("Out of bounds"),o):e}