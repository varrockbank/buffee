function Buffee(e,{rows:t,cols:o,spaces:s=4,logger:l,callbacks:n}={}){this.version="12.2.3-alpha.1";const r=this,i=e=>a.spaces?e.replace(/\t/g," ".repeat(a.spaces)):e,c=e=>/\s/.test(e);isWord=e=>/[\p{L}\p{Nd}_]/u.test(e);const a={spaces:s,interactive:1},h=Object.entries(n||{}),d=t=>parseFloat(getComputedStyle(e).getPropertyValue(t)),f=d("--buffee-cell"),w=d("--buffee-padding"),u=d("--buffee-gutter-digits-initial");let g=-1;const p=()=>g+d("--buffee-gutter-digits-padding"),m=(e,t)=>e.querySelector(t),y=m(e,".buffee-elements"),C=m(y,".buffee-lines"),v=m(y,".buffee-cursor"),k=m(y,".buffee-layer-text"),L=m(e,".buffee-clipboard-bridge"),x=m(y,".buffee-gutter");if(o&&!x&&(y.style.width=`calc(${o}ch + ${2*w}px)`),t){const e=t*f+"px";k.style.height=e,x&&(x.style.height=e)}const S=[],[b,z,K]=[0,0,0].map(()=>document.createDocumentFragment()),M={row:0,col:0};let D={row:0,col:0},E=D,I=D.col;const $=this.Selection={get ordered(){return this.isForwardSelection?[E,D]:[D,E]},moveRow(e){e>0?D.row<O.lastIndex&&(D.col=Math.min(I,O.lines[++D.row].length),D.row>A.end&&(A.start=D.row-A.size+1)):D.row>0&&(D.col=Math.min(I,O.lines[--D.row].length),D.row<A.start&&(A.start=D.row)),B()},moveCol(e){1===e?D.col<O.lines[D.row].length?I=++D.col:D.row<O.lastIndex&&(I=D.col=0,++D.row>A.end&&(A.start=D.row-A.size+1)):-1===e&&(D.col>0?I=--D.col:D.row>0&&(I=D.col=O.lines[--D.row].length,D.row<A.start&&(A.start=D.row))),B()},get isSelection(){return D!==E},get isForwardSelection(){return E.row===D.row&&E.col<D.col||E.row<D.row},setCursor({row:e,col:t}){D.row=e,D.col=t,this.makeCursor()},get lines(){const[e,t]=this.ordered;if(e.row===t.row){const o=O.lines[e.row],s=e.row===O.lastIndex,l=o.slice(e.col,t.col);return t.col>=o.length&&!s?[l,""]:[l]}{const o=O.lines[e.row].slice(e.col),s=O.lines[t.row].slice(0,t.col);return[o,...O.lines.slice(e.row+1,t.row),s]}},makeCursor(){E.row=D.row,E.col=D.col,D=E},makeSelection(){D=M,D.row=E.row,D.col=E.col},moveCursorStartOfLine(){var e;I=D.col=(e=O.lines[D.row].search(/[^ ]/))>0&&e<E.col?e:0,B()},moveCursorEndOfLine(){I=D.col=O.lines[D.row].length,B()},insert(e,t=!1){if(e=i(e),this.isSelection){const[t]=this.ordered,o=this.lines.join("\n");r._.delete(t.row,t.col,o);const s=r._.insert(t.row,t.col,e);s?.length>1?(D.row=t.row+s.length-1,D.col=s[s.length-1].length):(D.row=t.row,D.col=t.col+e.length),this.makeCursor()}else{const t=r._.insert(E.row,E.col,e);t?.length>1?(D.row+=t.length-1,I=D.col=t[t.length-1].length):I=D.col+=e.length}t||B()},delete(){if(this.isSelection)return this.insert("");if(E.col>0){const e=O.lines[E.row][E.col-1];r._.delete(E.row,E.col-1,e),D.col--}else if(E.row>0){const e=O.lines[E.row-1].length;r._.delete(E.row-1,e,"\n"),D.col=e,D.row--,D.row<A.start&&(A.start=D.row)}B()},newLine(){this.isSelection&&$.insert("",!0),r._.insert(E.row,E.col,"\n"),D.col=0,D.row++,D.row>A.end&&(A.start=D.row-A.size+1),B()},moveBackWord(){const e=O.lines[D.row];if(0===D.col)D.row>0&&(D.row--,D.col=O.lines[D.row].length,D.row<A.start&&(A.start=D.row));else{let t=D.col;if(c(e[t])){for(;t>0&&c(e[t]);)t--;for(;t>0&&isWord(e[t]);)t--}else if(isWord(e[t]))for(;t>0&&isWord(e[t]);)t--;else{const o=e[t--];for(;t>0&&e[t]===o;)t--}D.col=t}B()},moveWord(){const e=O.lines[D.row],t=e.length;if(D.col===t)D.row<O.lastIndex&&(D.col=0,D.row++,D.row>A.end&&(A.start=D.row-A.size+1));else{const o=e=>/\s/.test(e),s=e=>/[\p{L}\p{Nd}_]/u.test(e);let l=D.col;if(o(e[l])){for(;l<t&&o(e[l]);)l++;for(;l<t&&s(e[l]);)l++}else if(s(e[l]))for(;l<t&&s(e[l]);)l++;else{const o=e[l++];for(;l<t&&e[l]===o;)l++}D.col=l}B()},indent(){if(!this.isSelection)return;const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)O.lines[o]=" ".repeat(a.spaces)+O.lines[o];e.col+=a.spaces,t.col+=a.spaces,B()},unindent(){const[e,t]=this.ordered;for(let o=e.row;o<=t.row;o++)if(o===e.row||o===t.row){const s=o===e.row?e:t;let l=0,n=0;const r=O.lines[s.row];let i=s.col;for(;i<r.length&&" "===r.charAt(i);)i++;for(n=i-s.col,i=0;i<s.col&&" "===r.charAt(i);)i++;l=i;const c=Math.min(a.spaces,l+n);O.lines[s.row]=O.lines[s.row].slice(c),n<c&&(s.col-=c-n)}else{const e=O.lines[o];let t=0;for(let o=0;o<Math.min(a.spaces,e.length)&&" "===e.charAt(o);o++)t++;O.lines[o]=e.slice(t)}B()}},_=[],O=this.Model={lines:[""],byteCount:"",originalLineCount:0,get lastIndex(){return this.lines.length-1},set text(e){e=i(e),this.lines=e.split("\n"),this.byteCount=(new TextEncoder).encode(e).length,this.originalLineCount=this.lines.length,B()},splice(e,t,o=0){this.lines.splice(e,o,...t),B()},delete(e){this.lines.splice(e,1)}};const A=this.Viewport={start:0,autoFit:t?0:1,size:t||0,delta:t||1,get displayLines(){return this.size+this.autoFit},get end(){return Math.min(this.start+this.size-1,O.lastIndex)},scroll(e){this.start=$clamp(this.start+e,0,O.lastIndex),B()},set(e,t){this.start=$clamp(e-1,0,O.lastIndex),this.delta+=t-this.size,this.size=t,B()},get lines(){return O.lines.slice(this.start,this.end+1)}};let F={lineCount:0,row:0,col:0,frameCount:0},W={lineCount:-1,row:-1,col:-1,frameCount:-1};function H(e,t,o){const s=S[e].style;null!=t&&(s.left=t+"ch"),null!=o&&(s.width=o+"ch")}function B(){F.lineCount=O.lastIndex+1,F.row=D.row,F.col=D.col,F.spaces=a.spaces,F.frameCount=W.frameCount+1;for(const[e,t]of h)F[e]!==W[e]&&t(F,r);const e=W;if(W=F,F=e,x){const e=Math.max(u,(A.start+A.displayLines).toString().length);e!==g&&(g=e,x.style.width=p()+"ch",o&&(y.style.width=`calc(${p()+o}ch + ${4*w}px)`))}const t=A.delta;if(t){if(t>0){const e=S.length;for(let o=0;o<t;o++){b.appendChild(document.createElement("pre")),K.appendChild(document.createElement("div"));const t=S[e+o]=z.appendChild(document.createElement("div"));t.className="buffee-selection",t.style.top=(e+o)*f+"px"}k.appendChild(b),C.appendChild(z),x&&x.appendChild(K)}else for(let e=0;e<-t;e++)x&&x.lastChild?.remove(),k.lastChild?.remove(),S.pop()?.remove();A.delta=0}for(let e=0;e<A.displayLines;e++)x&&(x.children[e].textContent=A.start+e+1),k.children[e].textContent=O.lines[A.start+e]??null,S[e].style.width=0;if(a.interactive<0)v.style.left="-1ch";else{const[e,t]=$.ordered,o=e.row-A.start,s=t.row-A.start;for(let o=e.row+1;o<=t.row-1;o++){const e=o-A.start;e>=0&&e<A.size&&H(e,0,O.lines[o].length+1)}if(o>=0&&o<A.size){const s=t.row===e.row?t.col-e.col:O.lines[e.row].length-e.col+1;H(o,e.col,s)}if(t.row!==e.row&&s>=0&&s<A.size){H(s,0,Math.min(t.col,O.lines[t.row].length))}const l=D.row-A.start;if(l>=0&&l<A.size){v.style.top=l*f+"px",v.style.left=D.col+"ch";const e=C.getBoundingClientRect(),t=v.getBoundingClientRect(),o=t.width||14;if(t.left<e.left){const s=e.left-t.left,l=Math.ceil(s/o);C.scrollLeft-=l*o}else if(t.right>e.right){const s=t.right-e.right,l=Math.ceil(s/o);C.scrollLeft+=l*o}C.scrollLeft=Math.round(C.scrollLeft/o)*o}}for(const e of _)e(C,A,t)}if(this.lineHeight=f,this.Mode=a,this._={get head(){return D},get tail(){return E},get contentOffset(){return{ch:x?p():0,px:x?3*w:w,top:w}},$e:y,$l:C,$textLayer:k,render:B,renderHooks:_,_insert:function(e,t,o){if(0===o.length)return null;if(1===o.length&&"\n"!==o)return O.lines[e]=O.lines[e].slice(0,t)+o+O.lines[e].slice(t),null;const s=o.split("\n");if(1===s.length)O.lines[e]=O.lines[e].slice(0,t)+o+O.lines[e].slice(t);else{const o=O.lines[e].slice(0,t),l=O.lines[e].slice(t);O.lines[e]=o+s[0];const n=s.slice(1,-1),r=s[s.length-1]+l;O.lines.splice(e+1,0,...n,r)}return s},_delete:function(e,t,o){if(0===o.length)return;const s=o.split("\n");if(1===s.length)O.lines[e]=O.lines[e].slice(0,t)+O.lines[e].slice(t+o.length);else{const o=O.lines[e].slice(0,t),l=e+s.length-1,n=s[s.length-1].length,r=O.lines[l].slice(n);O.lines[e]=o+r,O.lines.splice(e+1,s.length-1)}},appendLines(e,t=!1){O.lines.push(...e.map(i)),t||B()}},A.autoFit){const e=()=>{const e=Math.floor(y.clientHeight/f);e>0&&e!==A.size&&(A.delta+=e-A.size,A.size=e,B())};requestAnimationFrame(e),new ResizeObserver(e).observe(y)}else B();C.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");t&&$.insert(t)});const R=e=>{e.preventDefault(),e.clipboardData.setData("text/plain",$.lines.join("\n"))};L.addEventListener("copy",R),L.addEventListener("cut",e=>{R(e),$.delete(),C.focus({preventScroll:!0})});const j={ArrowDown:2,ArrowUp:-2,ArrowLeft:-1,ArrowRight:1};C.addEventListener("keydown",e=>{if((e.metaKey||e.ctrlKey)&&"v"===e.key.toLowerCase())return;if((e.metaKey||e.ctrlKey)&&("c"===e.key.toLowerCase()||"x"===e.key.toLowerCase()))return L.focus({preventScroll:!0}),void L.select();if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&!e.shiftKey)return e.preventDefault(),void(r.History&&r.History.undo());if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&e.shiftKey)return e.preventDefault(),void(r.History&&r.History.redo());const t=j[e.key]||0;if(t){const o=t>>31|1;if(e.preventDefault(),-1===a.interactive)return;if(e.metaKey)!e.shiftKey&&$.isSelection&&$.makeCursor(),e.shiftKey&&!$.isSelection&&$.makeSelection(),t%2&&$[o>0?"moveCursorEndOfLine":"moveCursorStartOfLine"]();else if(e.altKey)!e.shiftKey&&$.isSelection&&$.makeCursor(),e.shiftKey&&!$.isSelection&&$.makeSelection(),t%2&&$[o>0?"moveWord":"moveBackWord"]();else if(!e.shiftKey&&$.isSelection)if(t%2)$.setCursor($.ordered[o>0|0]),B();else{const e=$.ordered[o>0|0],t=$clamp(e.row+o,0,O.lastIndex);t<A.start?A.start=t:t>A.end&&(A.start=t-A.size+1),I=Math.min(e.col,O.lines[t].length),$.setCursor({row:t,col:I}),B()}else e.shiftKey&&!$.isSelection&&$.makeSelection(),$[t%2?"moveCol":"moveRow"](o)}else 1!==a.interactive||("Backspace"===e.key?$.delete():"Enter"===e.key?$.newLine():"Escape"===e.key||("Tab"===e.key?(e.preventDefault(),e.shiftKey?$.unindent():$.isSelection?$.indent():$.insert(" ".repeat(a.spaces))):e.key.length>1?l.warn("Ignoring unknown key: ",e.code,e.key):(" "===e.key&&e.preventDefault(),$.insert(e.key))))})}function $clamp(e,t,o){return e<t?(logger.warn("Out of bounds"),t):e>o?(logger.warn("Out of bounds"),o):e}