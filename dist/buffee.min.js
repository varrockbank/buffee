function Buffee(e,{rows:t,cols:s,spaces:o=4}={}){this.version="12.6.3-alpha.1";const l=this,r=e=>c.spaces?e.replace(/\t/g," ".repeat(c.spaces)):e,n=e=>/\s/.test(e),i=e=>/[\p{L}\p{Nd}_]/u.test(e),c={spaces:o,interactive:1},a=t=>parseFloat(getComputedStyle(e).getPropertyValue(t)),h=a("--buffee-cell"),f=a("--buffee-padding"),w=a("--buffee-gutter-digits-initial");let d=-1;const u=()=>d+a("--buffee-gutter-digits-padding"),g=(e,t)=>e.querySelector(t),p=g(e,".buffee-elements"),y=g(p,".buffee-lines"),m=g(p,".buffee-cursor"),v=g(p,".buffee-layer-text"),C=g(p,".buffee-layer-selection"),L=g(e,".buffee-clipboard-bridge"),k=g(p,".buffee-gutter");if(s&&!k&&(p.style.width=`calc(${s}ch + ${2*f}px)`),t){const e=t*h+"px";v.style.height=e,k&&(k.style.height=e),C.style.height=e}const S=[[[],document.createDocumentFragment(),v,"pre",(e,t)=>e.textContent=E.lines[M.start+t]??null],[[],document.createDocumentFragment(),k,"div",(e,t)=>e.textContent=M.start+t+1],[[],document.createDocumentFragment(),C,"div",e=>e.style.width=0]],x={row:0,col:0};let b={row:0,col:0},z=b,K=b.col;const _=this.Selection={get ordered(){return this.isForwardSelection?[z,b]:[b,z]},moveRow(e){e>0?b.row<E.lastIndex&&(b.col=Math.min(K,E.lines[++b.row].length),b.row>M.end&&(M.start=b.row-M.size+1)):b.row>0&&(b.col=Math.min(K,E.lines[--b.row].length),b.row<M.start&&(M.start=b.row)),I()},moveCol(e){1===e?b.col<E.lines[b.row].length?K=++b.col:b.row<E.lastIndex&&(K=b.col=0,++b.row>M.end&&(M.start=b.row-M.size+1)):b.col>0?K=--b.col:b.row>0&&(K=b.col=E.lines[--b.row].length,b.row<M.start&&(M.start=b.row)),I()},get isSelection(){return b!==z},get isForwardSelection(){return z.row===b.row&&z.col<b.col||z.row<b.row},setCursor({row:e,col:t}){b.row=e,b.col=t,this.makeCursor()},get lines(){const[e,t]=this.ordered;if(e.row===t.row){const s=E.lines[e.row],o=[s.slice(e.col,t.col)];return t.col>=s.length&&e.row<E.lastIndex&&o.push(""),o}{const s=E.lines[e.row].slice(e.col),o=E.lines[t.row].slice(0,t.col);return[s,...E.lines.slice(e.row+1,t.row),o]}},makeCursor(){z.row=b.row,z.col=b.col,b=z},makeSelection(){b=x,b.row=z.row,b.col=z.col},moveCursorStartOfLine(){var e;K=b.col=(e=E.lines[b.row].search(/[^ ]/))>0&&e<z.col?e:0,I()},moveCursorEndOfLine(){K=b.col=E.lines[b.row].length,I()},insert(e,t=!1){if(e=r(e),this.isSelection){const[t]=this.ordered,s=this.lines.join("\n");l._._delete(t.row,t.col,s);const o=l._._insert(t.row,t.col,e);b.row=t.row,o?.length>1?(b.row+=o.length-1,b.col=o[o.length-1].length):b.col=t.col+e.length,this.makeCursor()}else{const t=l._._insert(z.row,z.col,e);t?.length>1?(b.row+=t.length-1,K=b.col=t[t.length-1].length):K=b.col+=e.length}t||I()},delete(){if(this.isSelection)return this.insert("");if(z.col>0){const e=E.lines[z.row][z.col-1];l._._delete(z.row,z.col-1,e),b.col--}else if(z.row>0){const e=E.lines[z.row-1].length;l._._delete(z.row-1,e,"\n"),b.col=e,--b.row<M.start&&(M.start=b.row)}I()},newLine(){this.isSelection&&_.insert("",!0),l._._insert(z.row,z.col,"\n"),b.col=0,b.row++,b.row>M.end&&(M.start=b.row-M.size+1),I()},moveBackWord(){if(0===b.col)b.row>0&&(b.col=E.lines[--b.row].length,b.row<M.start&&(M.start=b.row));else{const e=E.lines[b.row];let t=b.col;if(n(e[t])){for(;t>0&&n(e[t]);)t--;for(;t>0&&i(e[t]);)t--}else if(i(e[t]))for(;t>0&&i(e[t]);)t--;else{const s=e[t--];for(;t>0&&e[t]===s;)t--}b.col=t}I()},moveWord(){const e=E.lines[b.row],t=e.length;if(b.col===t)b.row<E.lastIndex&&(b.col=0,++b.row>M.end&&(M.start=b.row-M.size+1));else{let s=b.col;if(n(e[s])){for(;s<t&&n(e[s]);)s++;for(;s<t&&i(e[s]);)s++}else if(i(e[s]))for(;s<t&&i(e[s]);)s++;else{const o=e[s++];for(;s<t&&e[s]===o;)s++}b.col=s}I()},indent(){if(!this.isSelection)return;const[e,t]=this.ordered;for(let s=e.row;s<=t.row;s++)E.lines[s]=" ".repeat(c.spaces)+E.lines[s];e.col+=c.spaces,t.col+=c.spaces,I()},unindent(){const[e,t]=this.ordered;for(let s=e.row;s<=t.row;s++)if(s===e.row||s===t.row){const o=s===e.row?e:t;let l=0,r=0;const n=E.lines[o.row];let i=o.col;for(;i<n.length&&" "===n.charAt(i);)i++;for(r=i-o.col,i=0;i<o.col&&" "===n.charAt(i);)i++;l=i;const a=Math.min(c.spaces,l+r);E.lines[o.row]=E.lines[o.row].slice(a),r<a&&(o.col-=a-r)}else{const e=E.lines[s];let t=0;for(;t<c.spaces&&" "===e[t];)t++;E.lines[s]=e.slice(t)}I()}},D=[],E=this.Model={lines:[""],byteCount:"",originalLineCount:0,get lastIndex(){return this.lines.length-1},set text(e){e=r(e),this.lines=e.split("\n"),this.byteCount=(new TextEncoder).encode(e).length,this.originalLineCount=this.lines.length,I()},splice(e,t,s=0){this.lines.splice(e,s,...t),I()},delete(e){this.lines.splice(e,1)}};const M=this.Viewport={start:0,autoFit:t?0:1,size:t||0,delta:t||1,get displayLines(){return this.size+this.autoFit},get end(){return Math.min(this.start+this.size-1,E.lastIndex)},scroll(e){this.start=$clamp(this.start+e,0,E.lastIndex),I()},set(e,t){this.start=$clamp(e-1,0,E.lastIndex),this.delta+=t-this.size,this.size=t,I()},get lines(){return E.lines.slice(this.start,this.end+1)}};let $=0;function F(e,t,s){const o=S[2][0][e].style;o.left=t+"ch",o.width=s+"ch"}function I(){if($++,k){const e=Math.max(w,(M.start+M.displayLines).toString().length);e!==d&&(d=e,k.style.width=u()+"ch",s&&(p.style.width=`calc(${u()+s}ch + ${4*f}px)`))}const e=M.delta;if(e){if(e>0){for(let t=0;t<e;t++)S.forEach(([e,t,,s])=>e.push(t.appendChild(document.createElement(s))));S.forEach(([,e,t])=>t?.appendChild(e))}else for(let t=0;t<-e;t++)S.forEach(([e])=>e.pop()?.remove());M.delta=0}for(let e=0;e<M.displayLines;e++)S.forEach(([t,,,,s])=>t[e]&&s(t[e],e));if(c.interactive<0)m.style.left="-1ch";else{const[e,t]=_.ordered,s=e.row-M.start,o=t.row-M.start;for(let s=e.row+1;s<=t.row-1;s++){const e=s-M.start;e>=0&&e<M.size&&F(e,0,E.lines[s].length+1)}if(s>=0&&s<M.size){const o=t.row===e.row?t.col-e.col:E.lines[e.row].length-e.col+1;F(s,e.col,o)}t.row!==e.row&&o>=0&&o<M.size&&F(o,0,Math.min(t.col,E.lines[t.row].length));const l=b.row-M.start;if(l>=0&&l<M.size){m.style.top=l*h+"px",m.style.left=b.col+"ch";const e=y.getBoundingClientRect(),t=m.getBoundingClientRect(),s=t.width||14;if(t.left<e.left){const o=e.left-t.left,l=Math.ceil(o/s);y.scrollLeft-=l*s}else if(t.right>e.right){const o=t.right-e.right,l=Math.ceil(o/s);y.scrollLeft+=l*s}y.scrollLeft=Math.round(y.scrollLeft/s)*s}}for(const t of D)t(y,M,e)}if(this.lineHeight=h,this.Mode=c,this._={get head(){return b},get tail(){return z},get frameCount(){return $},get contentOffset(){return{ch:k?u():0,px:k?3*f:f,top:f}},$e:p,$l:y,$textLayer:v,render:I,renderHooks:D,_insert:function(e,t,s){if(0===s.length)return null;if(1===s.length&&"\n"!==s)return E.lines[e]=E.lines[e].slice(0,t)+s+E.lines[e].slice(t),null;const o=s.split("\n");if(1===o.length)E.lines[e]=E.lines[e].slice(0,t)+s+E.lines[e].slice(t);else{const s=E.lines[e].slice(0,t),l=E.lines[e].slice(t);E.lines[e]=s+o[0];const r=o.slice(1,-1),n=o[o.length-1]+l;E.lines.splice(e+1,0,...r,n)}return o},_delete:function(e,t,s){if(0===s.length)return;const o=s.split("\n");if(1===o.length)E.lines[e]=E.lines[e].slice(0,t)+E.lines[e].slice(t+s.length);else{const s=E.lines[e].slice(0,t),l=e+o.length-1,r=o[o.length-1].length,n=E.lines[l].slice(r);E.lines[e]=s+n,E.lines.splice(e+1,o.length-1)}},appendLines(e,t=!1){E.lines.push(...e.map(r)),t||I()}},M.autoFit){const e=()=>{const e=Math.floor(p.clientHeight/h);e>0&&e!==M.size&&(M.delta+=e-M.size,M.size=e,I())};requestAnimationFrame(e),new ResizeObserver(e).observe(p)}else I();y.addEventListener("paste",e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");t&&_.insert(t)});const A=e=>{e.preventDefault(),e.clipboardData.setData("text/plain",_.lines.join("\n"))};L.addEventListener("copy",A),L.addEventListener("cut",e=>{A(e),_.delete(),y.focus({preventScroll:!0})});const H={ArrowDown:2,ArrowUp:-2,ArrowLeft:-1,ArrowRight:1};y.addEventListener("keydown",e=>{if((e.metaKey||e.ctrlKey)&&"v"===e.key.toLowerCase())return;if((e.metaKey||e.ctrlKey)&&("c"===e.key.toLowerCase()||"x"===e.key.toLowerCase()))return L.focus({preventScroll:!0}),void L.select();if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&!e.shiftKey)return e.preventDefault(),void(l.History&&l.History.undo());if((e.metaKey||e.ctrlKey)&&"z"===e.key.toLowerCase()&&e.shiftKey)return e.preventDefault(),void(l.History&&l.History.redo());const t=H[e.key]||0;if(t){const s=t>>31|1;if(e.preventDefault(),-1===c.interactive)return;if(e.metaKey)!e.shiftKey&&_.isSelection&&_.makeCursor(),e.shiftKey&&!_.isSelection&&_.makeSelection(),t%2&&_[s>0?"moveCursorEndOfLine":"moveCursorStartOfLine"]();else if(e.altKey)!e.shiftKey&&_.isSelection&&_.makeCursor(),e.shiftKey&&!_.isSelection&&_.makeSelection(),t%2&&_[s>0?"moveWord":"moveBackWord"]();else if(!e.shiftKey&&_.isSelection)if(t%2)_.setCursor(_.ordered[s>0|0]),I();else{const e=_.ordered[s>0|0],t=$clamp(e.row+s,0,E.lastIndex);t<M.start?M.start=t:t>M.end&&(M.start=t-M.size+1),K=Math.min(e.col,E.lines[t].length),_.setCursor({row:t,col:K}),I()}else e.shiftKey&&!_.isSelection&&_.makeSelection(),_[t%2?"moveCol":"moveRow"](s)}else 1!==c.interactive||"Escape"===e.key||("Backspace"===e.key?_.delete():"Enter"===e.key?_.newLine():"Tab"===e.key?(e.preventDefault(),e.shiftKey?_.unindent():_.isSelection?_.indent():_.insert(" ".repeat(c.spaces))):1==e.key.length&&(" "===e.key&&e.preventDefault(),_.insert(e.key)))})}function $clamp(e,t,s){return e<t?t:e>s?s:e}